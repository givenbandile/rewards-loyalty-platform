<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Video Rewards</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">

  <!-- Firebase 10.7.0 Compat -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-check-compat.js"></script>
</head>
<body>
  

<header>
  <h1>ðŸŽ¬ Video Rewards</h1>
  <button id="darkToggle">ðŸŒ™ Dark Mode</button>
</header>

<section id="hero">
  <h2>Watch. Earn. Withdraw.</h2>
  <p>Earn cash by watching videos.</p>
</section>

<section id="about">
  <h2>How It Works</h2>
  <ul>
    <li>ðŸ“º Watch short videos</li>
    <li>ðŸ’° Earn rewards</li>
    <li>ðŸ‡¿ðŸ‡¦ Withdraw in South Africa</li>
  </ul>
</section>

<section id="auth">
  <h2>Login / Sign Up</h2>
  <input id="email" type="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button onclick="login()">Login</button>
  <button onclick="signup()">Create Account</button>
</section>

<script>
/* ===== FIREBASE CONFIG ===== */
firebase.initializeApp({
  apiKey: "AIzaSyDBYzvleKKLKvKtkEuu8utwZHJnc70lh3E",
  authDomain: "videorewardsweb.firebaseapp.com",
  projectId: "videorewardsweb",
  storageBucket: "videorewardsweb.firebasestorage.app",
  messagingSenderId: "844494435984",
  appId: "1:844494435984:web:3011f3871a3eeefc95ca15"
});

// Activate App Check (Optional)
const appCheck = firebase.appCheck();
// Explicitly use the ReCaptchaV3Provider for cross-device compatibility
appCheck.activate(
  new firebase.appCheck.ReCaptchaV3Provider('6LeZI1EsAAAAAOhgs3Dru3eoYQcsJjRWQhkqjB39'),
  true // Enables auto-refresh (Essential for users staying on the page)
);

// Initialize Firestore & Auth
const auth = firebase.auth();
const db = firebase.firestore();

/* ===== AUTH + ROLE-BASED REDIRECT ===== */
auth.onAuthStateChanged(async (user) => {
  if (!user) return; // Not logged in, stay on page

  try {
    const userDoc = await db.collection("users").doc(user.uid).get();

    if (userDoc.exists) {
      const userData = userDoc.data();

      if (userData.role === "admin") {
        console.log("Admin detected, redirecting to Admin Panel...");
        window.location.href = "admin.html";
      } else {
        console.log("Standard user detected, redirecting to Dashboard...");
        window.location.href = "dashboard.html";
      }

    } else {
      // First time signup, send to dashboard
      console.log("No user doc yet, redirecting to Dashboard...");
      window.location.href = "dashboard.html";
    }
  } catch (error) {
    console.error("Error checking user role:", error);
    window.location.href = "dashboard.html";
  }
});

/* ===== LOGIN / SIGNUP ===== */
async function login() {
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();
  if (!email || !password) return alert("Enter email and password");

  try {
    await auth.signInWithEmailAndPassword(email, password);
  } catch (err) {
    console.error(err);
    alert("Login failed: " + err.message);
  }
}

async function signup() {
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();
  if (!email || !password) return alert("Enter email and password");

  try {
    const userCred = await auth.createUserWithEmailAndPassword(email, password);
    // Create user profile in Firestore
    await db.collection("users").doc(userCred.user.uid).set({
      email: email,
      role: "user",
      balance: 0,
      status: "active",
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    alert("Account created! Redirecting...");
  } catch (err) {
    console.error(err);
    alert("Signup failed: " + err.message);
  }
}

/* ===== DARK MODE TOGGLE ===== */
document.getElementById("darkToggle").onclick = () =>
  document.body.classList.toggle("dark");
</script>

</body>
</html>
